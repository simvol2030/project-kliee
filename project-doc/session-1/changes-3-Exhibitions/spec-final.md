# Спецификация: Раздел Exhibitions — полноценное управление выставками

**Версия:** FINAL
**Дата:** 2026-01-08
**Автор:** Moderator + CLI
**Статус:** Готово для Developer

---

## Текущее состояние (проверено в браузере и коде)

### Хранение данных

| Компонент | Где сейчас | Что нужно |
|-----------|------------|-----------|
| **Выставки (exhibitions)** | JSON файл `data/exhibitions.json` | Мигрировать в БД |
| **Art Fairs** | JSON файл (раздел `artFairs`) | Добавить в БД (тип в exhibitions) |
| **Таблица exhibitions** | Существует в схеме Drizzle, но ПУСТАЯ | Заполнить данными |
| **Связь exhibition → artworks** | Таблица `exhibitionArtworks` есть | Работает |
| **Изображения выставки** | Только `cover_image_id` | Добавить галерею |

### Структура данных в JSON

**exhibitions.json содержит:**
- 9 выставок (id, year, title/venue/location на 4 языках, type, current, image)
- 5 art fairs (id, year, title/gallery/location на 4 языках)
- SEO данные

**Типы выставок:** solo, group, fair, festival, gallery

### Что работает на фронтенде

- Список выставок отображается из JSON
- 3 секции: Current, Past Exhibitions, Art Fairs
- Мультиязычность (4 языка) работает
- Светлая/тёмная тема работает
- У текущих выставок отображаются изображения

### Что есть в админке

- Раздел `/exhibitions` существует и работает с БД
- CRUD функционал реализован
- Таблица с колонками: Year, Title, Venue, Location, Current
- Кнопка "+ Add Exhibition"
- **НО: БД пустая — "0 exhibitions in database"**

### Что НЕ работает / отсутствует

- **Миграция данных** — JSON → БД не выполнена
- **Фронтенд читает JSON** — не БД (провайдер `exhibitions.provider.ts`)
- **Art Fairs в БД** — нет отдельной таблицы
- **Страница отдельной выставки** — НЕТ (`/[lang]/exhibitions/[id]`)
- **Галерея выставки** — только cover image, нет мульти-фото
- **Описание выставки** — в JSON нет, в БД поле есть (пустое)
- **Таймлайн** — просто сортировка по годам, нет отдельного управления

---

## Сопоставление: Есть сейчас vs Должно быть

| Аспект | Есть сейчас | Должно быть |
|--------|-------------|-------------|
| **Данные выставок** | JSON (9 шт) | SQLite БД |
| **Данные Art Fairs** | JSON (5 шт) | SQLite БД (тип в exhibitions) |
| **Фронтенд — источник** | `exhibitions.provider.ts` → JSON | Провайдер → БД |
| **Админка — статус** | Работает, но БД пустая | Работает с данными |
| **Страница выставки** | НЕТ | Детальная страница с галереей |
| **Фото выставки** | 1 cover image | Галерея (несколько фото) |
| **Описание выставки** | НЕТ в JSON | Поле description (4 языка) |
| **Таймлайн** | Автоматический по годам | Редактируемый через админку |
| **Добавление задним числом** | Невозможно | Можно указать любую дату |

**URL фронтенда:** https://k-liee.com/en/exhibitions
**Админка:** https://k-liee.com/exhibitions (работает, БД пустая)

---

## Что на выходе

1. **Миграция выставок в БД** — данные из JSON перенесены без потерь
2. **Art Fairs в БД** — через поле type в exhibitions
3. **Фронтенд из БД** — провайдер переключен на SQLite
4. **Страница отдельной выставки** — `/[lang]/exhibitions/[slug]` с галереей и описанием
5. **Галерея выставки** — несколько фото с перелистыванием
6. **Описание выставки** — заполняется через админку (4 языка)
7. **Редактируемый таймлайн** — управление через админку
8. **Загрузка изображений** — оптимизация в webp, без дублирования
9. **Связь с главной** — выставки можно выбирать для отображения на homepage

---

## Что нужно сделать

### 1. Миграция выставок в БД

**Источник:** `data/exhibitions.json` (9 выставок + 5 art fairs)
**Цель:** Таблица `exhibitions` в SQLite

Таблица `exhibitions` уже существует с полями:
- id, title_en/ru/es/zh, description_en/ru/es/zh
- venue, city, country, address
- start_date, end_date, opening_hours
- cover_image_id, gallery_link
- is_current, is_visible, order_index

**Нужно добавить:**
- `type` — solo/group/fair/festival/gallery/art_fair
- `year` — год выставки (для таймлайна)
- `slug` — URL-friendly идентификатор
- Таблица `exhibitionImages` — для галереи фотографий

### 2. Art Fairs — использовать type

Art Fairs хранятся в той же таблице `exhibitions` с `type = 'art_fair'`.
Это упрощает код и админку.

### 3. Переключить фронтенд на БД

- Переписать `exhibitions.provider.ts` для работы с БД
- Заменить импорт JSON на запросы к SQLite
- Добавить фильтрацию по type для Art Fairs

### 4. Страница отдельной выставки

**Путь:** `/[lang]/exhibitions/[slug]`

Содержимое:
- Название выставки (мультиязычное)
- Описание (мультиязычное)
- Галерея фотографий с перелистыванием
- Информация: даты, venue, город, адрес
- Связанные работы (из `exhibitionArtworks`)
- Кнопка "Назад к списку"

### 5. Галерея фотографий выставки

**Новая таблица `exhibitionImages`:**
```sql
CREATE TABLE exhibition_images (
  id INTEGER PRIMARY KEY,
  exhibition_id INTEGER REFERENCES exhibitions(id) ON DELETE CASCADE,
  media_id INTEGER REFERENCES media(id),
  order_index INTEGER DEFAULT 0,
  caption_en TEXT,
  caption_ru TEXT,
  caption_es TEXT,
  caption_zh TEXT
);
```

### 6. Редактируемый таймлайн

Таймлайн на фронтенде = группировка выставок по годам.
- Поле `year` для выставки (извлекается из start_date или задаётся отдельно)
- Сортировка по году + order_index внутри года
- В админке можно менять order_index для управления порядком

### 7. Связь с главной страницей

Добавить:
- Поле `featured` в exhibitions (boolean) — показывать на главной
- В Homepage редакторе — выбор выставок для отображения

---

## Загрузка изображений — требования

### 1. Оптимизация в webp

- При загрузке конвертировать в webp
- Максимальный размер: **1500x1500px**
- Качество: 80-85%
- Использовать sharp или аналогичную библиотеку

### 2. Без дублирования

- Вычислять хэш файла (MD5 или SHA256) перед сохранением
- Проверять наличие файла с таким хэшем в таблице `media`
- Если файл существует — использовать существующую запись
- Добавить поле `file_hash` в таблицу `media`

### 3. Структура хранения

- Новые загрузки: `/uploads/exhibitions/`
- Существующие (совместимость): `/images/exhibitions/`
- В БД хранить относительный путь

### 4. UI загрузки

- Drag & drop для множественной загрузки
- Превью перед сохранением
- Прогресс-бар загрузки
- Сообщение если файл уже существует
- Возможность удалить/заменить изображение

---

## Факторы реализации

- **Не потерять данные** — сначала миграция JSON → БД, потом переключение провайдера
- **Таблица exhibitions готова** — схема подходит, нужно добавить type, year, slug
- **Админка работает** — только заполнить данными и добавить галерею
- **Мультиязычность** — 4 языка (EN/RU/ES/ZH) для всех текстов
- **Темы** — светлая/тёмная работают, не сломать
- **Добавление задним числом** — поле start_date позволяет любую дату
- **Изображения webp** — оптимизация при загрузке, макс 1500x1500px

---

## Критерии успеха

- [ ] Выставки загружаются из БД (не из JSON)
- [ ] Art Fairs загружаются из БД (type = 'art_fair')
- [ ] Данные из JSON перенесены без потерь (9 выставок + 5 art fairs)
- [ ] Админка: можно создать новую выставку
- [ ] Админка: можно редактировать существующую
- [ ] Админка: можно добавить выставку "задним числом"
- [ ] Страница выставки: галерея с несколькими фото
- [ ] Страница выставки: описание и информация
- [ ] Фронтенд: таймлайн отображается корректно
- [ ] Фронтенд: переключение языков работает
- [ ] Фронтенд: светлая/тёмная тема работает
- [ ] Изображения: оптимизируются в webp при загрузке (макс 1500x1500)
- [ ] Изображения: без дублирования (проверка по хэшу)
- [ ] Связь с главной: можно выбрать выставки для homepage

---

## Чек-лист для проверки в браузере

**Миграция (проверить что данные не потеряны):**
- [ ] Все 9 выставок отображаются на /en/exhibitions
- [ ] Все 5 art fairs отображаются в секции Art Fairs
- [ ] Названия на всех 4 языках корректны
- [ ] Изображения загружаются
- [ ] Таймлайн (группировка по годам) корректный

**Админка выставок:**
- [ ] Открыть /exhibitions — видны все выставки (14 записей)
- [ ] Создать тестовую выставку (название + описание + дата)
- [ ] Добавить несколько фотографий к выставке
- [ ] Редактировать существующую выставку
- [ ] Добавить выставку "задним числом" (например, 2020 год)
- [ ] Удалить тестовую выставку

**Страница отдельной выставки:**
- [ ] Кликнуть на выставку → открывается детальная страница
- [ ] Видно название и описание
- [ ] Галерея фотографий с перелистыванием
- [ ] Информация: даты, место, адрес
- [ ] Работает в светлой и тёмной теме
- [ ] Переключение языка работает

**Загрузка изображений:**
- [ ] Загрузить новое изображение → сохраняется как webp
- [ ] Загрузить большое изображение → уменьшается до 1500x1500
- [ ] Загрузить то же изображение повторно → НЕ дублируется
- [ ] Появляется сообщение "Изображение уже существует"

---

## Файлы для изменения (предварительно)

| Файл | Изменение |
|------|-----------|
| `src/lib/server/db/schema.ts` | Добавить type, year, slug, featured в exhibitions; создать exhibitionImages; добавить file_hash в media |
| `src/lib/data/exhibitions.provider.ts` | Переключить на БД |
| `data/exhibitions.json` | Источник для миграции → потом оставить как бэкап |
| `src/routes/[lang]/exhibitions/[slug]/+page.svelte` | Создать страницу выставки |
| `src/routes/[lang]/exhibitions/[slug]/+page.ts` | Загрузчик данных |
| `src/routes/(admin)/exhibitions/[id]/+page.svelte` | Добавить загрузку галереи |
| `src/lib/server/upload.ts` | Добавить оптимизацию webp и проверку дубликатов |

---

*FINAL — одобрено Moderator, готово для Developer*
