# Спецификация: Раздел Exhibitions — полноценное управление выставками

**Версия:** v2 (после исследования)
**Дата:** 2026-01-08
**Автор:** Moderator → CLI

---

## Текущее состояние (проверено в браузере и коде)

### Хранение данных

| Компонент | Где сейчас | Что нужно |
|-----------|------------|-----------|
| **Выставки (exhibitions)** | JSON файл `data/exhibitions.json` | Мигрировать в БД |
| **Art Fairs** | JSON файл (раздел `artFairs`) | Добавить таблицу в БД |
| **Таблица exhibitions** | Существует в схеме Drizzle, но ПУСТАЯ | Заполнить данными |
| **Связь exhibition → artworks** | Таблица `exhibitionArtworks` есть | Работает |
| **Изображения выставки** | Только `cover_image_id` | Добавить галерею |

### Структура данных в JSON

**exhibitions.json содержит:**
- 9 выставок (id, year, title/venue/location на 4 языках, type, current, image)
- 5 art fairs (id, year, title/gallery/location на 4 языках)
- SEO данные

**Типы выставок:** solo, group, fair, festival, gallery

### Что работает на фронтенде

- Список выставок отображается из JSON
- 3 секции: Current, Past Exhibitions, Art Fairs
- Мультиязычность (4 языка) работает
- Светлая/тёмная тема работает
- У текущих выставок отображаются изображения

### Что есть в админке

- Раздел `/exhibitions` существует и работает с БД
- CRUD функционал реализован
- Таблица с колонками: Year, Title, Venue, Location, Current
- Кнопка "+ Add Exhibition"
- **НО: БД пустая — "0 exhibitions in database"**

### Что НЕ работает / отсутствует

- **Миграция данных** — JSON → БД не выполнена
- **Фронтенд читает JSON** — не БД (провайдер `exhibitions.provider.ts`)
- **Art Fairs в БД** — нет отдельной таблицы
- **Страница отдельной выставки** — НЕТ (`/[lang]/exhibitions/[id]`)
- **Галерея выставки** — только cover image, нет мульти-фото
- **Описание выставки** — в JSON нет, в БД поле есть (пустое)
- **Таймлайн** — просто сортировка по годам, нет отдельного управления

---

## Сопоставление: Есть сейчас vs Должно быть

| Аспект | Есть сейчас | Должно быть |
|--------|-------------|-------------|
| **Данные выставок** | JSON (9 шт) | SQLite БД |
| **Данные Art Fairs** | JSON (5 шт) | SQLite БД (отдельная таблица или тип) |
| **Фронтенд — источник** | `exhibitions.provider.ts` → JSON | Провайдер → БД |
| **Админка — статус** | Работает, но БД пустая | Работает с данными |
| **Страница выставки** | НЕТ | Детальная страница с галереей |
| **Фото выставки** | 1 cover image | Галерея (несколько фото) |
| **Описание выставки** | НЕТ в JSON | Поле description (4 языка) |
| **Таймлайн** | Автоматический по годам | Редактируемый через админку |
| **Добавление задним числом** | Невозможно | Можно указать любую дату |

**URL фронтенда:** https://k-liee.com/en/exhibitions
**Админка:** https://k-liee.com/exhibitions (работает, БД пустая)

---

## Что на выходе

1. **Миграция выставок в БД** — данные из JSON перенесены без потерь
2. **Art Fairs в БД** — отдельная таблица или поле type
3. **Фронтенд из БД** — провайдер переключен на SQLite
4. **Страница отдельной выставки** — `/[lang]/exhibitions/[slug]` с галереей и описанием
5. **Галерея выставки** — несколько фото с перелистыванием
6. **Описание выставки** — заполняется через админку (4 языка)
7. **Редактируемый таймлайн** — управление через админку
8. **Загрузка изображений** — оптимизация в webp, без дублирования
9. **Связь с главной** — выставки можно выбирать для отображения на homepage

---

## Что нужно сделать

### 1. Миграция выставок в БД

**Источник:** `data/exhibitions.json` (9 выставок + 5 art fairs)
**Цель:** Таблицы `exhibitions` и `artFairs` (или расширить существующую)

Таблица `exhibitions` уже существует с полями:
- id, title_en/ru/es/zh, description_en/ru/es/zh
- venue, city, country, address
- start_date, end_date, opening_hours
- cover_image_id, gallery_link
- is_current, is_visible, order_index

**Нужно добавить:**
- `type` — solo/group/fair/festival/gallery
- `year` — год выставки (для таймлайна)
- Таблица `exhibitionImages` — для галереи фотографий

### 2. Art Fairs — отдельная таблица или тип

Варианты:
1. Добавить `type = 'art_fair'` в существующую таблицу exhibitions
2. Создать отдельную таблицу `artFairs`

**Рекомендация:** использовать поле `type` в exhibitions (проще)

### 3. Переключить фронтенд на БД

- Создать `exhibitions.db-provider.ts` (или переписать существующий)
- Заменить импорт в `[lang]/exhibitions/+page.ts`
- Добавить загрузку Art Fairs из БД

### 4. Страница отдельной выставки

**Путь:** `/[lang]/exhibitions/[slug]` или `/[lang]/exhibitions/[id]`

Содержимое:
- Название выставки
- Описание (мультиязычное)
- Галерея фотографий с перелистыванием
- Информация: даты, venue, город, адрес
- Связанные работы (из `exhibitionArtworks`)
- Кнопка "Назад к списку"

### 5. Галерея фотографий выставки

**Новая таблица `exhibitionImages`:**
```sql
CREATE TABLE exhibition_images (
  id INTEGER PRIMARY KEY,
  exhibition_id INTEGER REFERENCES exhibitions(id),
  media_id INTEGER REFERENCES media(id),
  order_index INTEGER DEFAULT 0,
  caption_en TEXT,
  caption_ru TEXT,
  caption_es TEXT,
  caption_zh TEXT
);
```

### 6. Редактируемый таймлайн

Таймлайн на фронтенде = группировка выставок по годам.
Добавить в админку:
- Поле `year` для выставки
- Сортировка по году + order_index внутри года

### 7. Загрузка изображений

- Оптимизация при загрузке → webp
- Проверка по хэшу → без дублирования
- Связь через `exhibitionImages` или `cover_image_id`

### 8. Связь с главной страницей

Добавить:
- Поле `featured` в exhibitions (boolean) — показывать на главной
- Или отдельная таблица `homepage_exhibitions`
- В Homepage редакторе — выбор выставок для отображения

---

## Загрузка изображений — требования

1. **Оптимизация в webp:**
   - При загрузке конвертировать в webp
   - Максимальный размер: 1500x1500px
   - Качество: 80-85%

2. **Без дублирования:**
   - Хэш файла перед сохранением
   - Проверка существующих в БД
   - Использовать существующий если есть

3. **Структура хранения:**
   - `/uploads/exhibitions/` — новые загрузки
   - `/images/exhibitions/` — существующие (совместимость)

---

## Факторы реализации

- **Не потерять данные** — сначала миграция JSON → БД
- **Таблица exhibitions готова** — схема подходит, нужно добавить type и year
- **Админка работает** — только заполнить данными
- **Мультиязычность** — 4 языка (EN/RU/ES/ZH)
- **Темы** — светлая/тёмная работают
- **Добавление задним числом** — поле start_date позволяет любую дату
- **Изображения webp** — оптимизация при загрузке

---

## Критерии успеха

- [ ] Выставки загружаются из БД (не из JSON)
- [ ] Art Fairs загружаются из БД
- [ ] Данные из JSON перенесены без потерь (9 + 5)
- [ ] Админка: можно создать новую выставку
- [ ] Админка: можно редактировать существующую
- [ ] Админка: можно добавить выставку "задним числом"
- [ ] Страница выставки: галерея с несколькими фото
- [ ] Страница выставки: описание и информация
- [ ] Фронтенд: таймлайн отображается корректно
- [ ] Фронтенд: переключение языков работает
- [ ] Фронтенд: светлая/тёмная тема работает
- [ ] Изображения: оптимизируются в webp при загрузке
- [ ] Изображения: без дублирования (проверка по хэшу)
- [ ] Связь с главной: можно выбрать выставки для homepage

---

## Чек-лист для проверки в браузере

**Миграция (проверить что данные не потеряны):**
- [ ] Все 9 выставок отображаются на /en/exhibitions
- [ ] Все 5 art fairs отображаются
- [ ] Названия на всех 4 языках корректны
- [ ] Изображения загружаются
- [ ] Таймлайн (группировка по годам) корректный

**Админка выставок:**
- [ ] Открыть /exhibitions — видны все выставки
- [ ] Создать тестовую выставку (название + описание + дата)
- [ ] Добавить несколько фотографий к выставке
- [ ] Редактировать существующую выставку
- [ ] Добавить выставку "задним числом" (2020 год)
- [ ] Удалить тестовую выставку

**Страница отдельной выставки:**
- [ ] Кликнуть на выставку → открывается детальная страница
- [ ] Видно название и описание
- [ ] Галерея фотографий с перелистыванием
- [ ] Информация: даты, место, адрес
- [ ] Работает в светлой и тёмной теме

**Загрузка изображений:**
- [ ] Загрузить новое изображение → сохраняется как webp
- [ ] Загрузить то же изображение повторно → НЕ дублируется
- [ ] Файл оптимизирован (размер меньше оригинала)

---

## Файлы для изменения (предварительно)

| Файл | Изменение |
|------|-----------|
| `src/lib/server/db/schema.ts` | Добавить type, year в exhibitions; создать exhibitionImages |
| `src/lib/data/exhibitions.provider.ts` | Переключить на БД |
| `data/exhibitions.json` | Источник для миграции → потом бэкап |
| `src/routes/[lang]/exhibitions/[slug]/+page.svelte` | Создать страницу выставки |
| `src/routes/(admin)/exhibitions/[id]/+page.svelte` | Добавить загрузку галереи |
| `src/lib/server/upload.ts` | Добавить оптимизацию webp |

---

*v2 — после исследования браузера и кода, передаётся Moderator для комментариев*
