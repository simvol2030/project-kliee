# Feedback v5 - Image Paths Bug (Shop/Catalog/Cart/Wishlist)

**Date:** 2025-12-23
**Priority:** HIGH
**Score:** 18
**Branch to create:** `claude/fix-image-paths-v5`

---

## Problem

Images not displaying in:
- `/en/catalog` - product cards
- `/en/shop` - product cards
- Cart dropdown
- Wishlist

## Root Cause

The `folder` field from `media` table is NOT included in API responses.

**Database has:**
```sql
SELECT id, stored_filename, folder FROM media LIMIT 3;
-- 4|chebu-rasha-blue.jpg|products
-- 5|chebu-rasha-breasts-teeth.jpg|products
```

**API returns:**
```json
"primary_image": {
  "id": 9,
  "stored_filename": "chebu-rasha-throwing-up-eyes.jpg",
  "alt_en": "...",
  // NO folder field!
}
```

**Frontend uses:**
```svelte
<!-- ProductCard.svelte:74 -->
`/uploads/${product.primary_image.stored_filename}`
<!-- Results in: /uploads/chebu-rasha-throwing-up-eyes.jpg -->
```

**But file is at:**
```
/opt/websites/k-liee.com/static-images/products/chebu-rasha-throwing-up-eyes.jpg
```

**Correct URL should be:**
```
/uploads/products/chebu-rasha-throwing-up-eyes.jpg
```

## Solution

### 1. Update API to include `folder` field

**File:** `src/routes/api/shop/products/+server.ts`

Update the `primary_image` interface:
```typescript
primary_image: {
  id: number;
  stored_filename: string;
  folder: string | null;  // ADD THIS
  alt_en: string | null;
  // ... rest
} | null;
```

Update the query to include `folder` from media table.

### 2. Update Frontend Components

**Files to update:**
- `src/lib/components/shop/ProductCard.svelte` (line 74)
- `src/lib/components/shop/CartDropdown.svelte` (line 148)
- `src/lib/components/shop/ProductGallery.svelte` (check usage)
- Any other components using image paths

**Change from:**
```svelte
`/uploads/${product.primary_image.stored_filename}`
```

**To:**
```svelte
`/uploads/${product.primary_image.folder || 'products'}/${product.primary_image.stored_filename}`
```

### 3. Check Cart API

**File:** `src/routes/api/shop/cart/+server.ts`

Ensure cart items also return `folder` field for images.

## Files to Modify

1. `src/routes/api/shop/products/+server.ts` - add folder to response
2. `src/lib/components/shop/ProductCard.svelte` - use folder in path
3. `src/lib/components/shop/CartDropdown.svelte` - use folder in path
4. `src/lib/components/shop/ProductGallery.svelte` - verify/fix
5. `src/routes/api/shop/cart/+server.ts` - add folder to cart items

## Acceptance Criteria

- [ ] Product images display in `/en/catalog`
- [ ] Product images display in `/en/shop`
- [ ] Product images display in cart dropdown
- [ ] Product images display in wishlist
- [ ] `npm run check` passes
- [ ] `npm run build` passes

## After Completion

```bash
git add .
git commit -m "fix: include folder in image paths for shop/catalog"
git push origin claude/fix-image-paths-v5
```

---

*Generated by Claude Code CLI (Integrator)*
*Workflow v4.2 | 2025-12-23*
